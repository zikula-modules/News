<?php
/**
 * News.
 *
 * @copyright Michael Ueberschaer (MU)
 * @license http://www.gnu.org/licenses/lgpl.html GNU Lesser General Public License
 * @author Michael Ueberschaer <info@homepages-mit-zikula.de>.
 * @link https://homepages-mit-zikula.de
 * @link http://zikula.org
 * @version Generated by ModuleStudio (https://modulestudio.de).
 */

/**
 * Replaces a given needle id by the corresponding content.
 *
 * @param array $args Arguments array
 *     int nid The needle id
 *
 * @return string Replaced value for the needle
 */
function MUNewsModule_needleapi_message_base(array $args = [])
{
    // Get arguments from argument array
    $nid = $args['nid'];
    unset($args);

    // cache the results
    static $cache;
    if (!isset($cache)) {
        $cache = [];
    }

    $container = \ServiceUtil::getManager();
    $translator = $container->get('translator.default');

    if (empty($nid)) {
        return '<em>' . htmlspecialchars($translator->__('No correct needle id given.')) . '</em>';
    }

    if (isset($cache[$nid])) {
        // needle is already in cache array
        return $cache[$nid];
    }

    if (!$container->get('kernel')->isBundle('MUNewsModule')) {
        $cache[$nid] = '<em>' . htmlspecialchars($translator->__f('Module "%moduleName%" is not available.', ['%moduleName%' => 'MUNewsModule'])) . '</em>';

        return $cache[$nid];
    }

    // strip application prefix from needle
    $needleId = str_replace('NEWS', '', $nid);

    $permissionApi = $container->get('zikula_permissions_module.api.permission');
    $router = $container->getService('router');

    if ($needleId == 'MESSAGES') {
        if (!$permissionApi->hasPermission('MUNewsModule:Message:', '::', ACCESS_READ)) {
            $cache[$nid] = '';

            return $cache[$nid];
        }
    }

    $cache[$nid] = '<a href="' . $router->generate('munewsmodule_messages_view') . '" title="' . $translator->__('View messages') . '">' . $translator->__('Messages') . '</a>';
    $needleParts = explode('-', $needleId);
    if ($needleParts[0] != 'MESSAGE' || count($needleParts) < 2) {
        $cache[$nid] = '';

        return $cache[$nid];
    }

    $entityId = (int)$needleParts[1];

    if (!$permissionApi->hasPermission('MUNewsModule:Message:', $entityId . '::', ACCESS_READ)) {
        $cache[$nid] = '';

        return $cache[$nid];
    }

    $repository = $container->get('mu_news_module.entity_factory')->getRepository('message');
    $entity = $repository->selectById($entityId);
    if (null === $entity) {
        $cache[$nid] = '<em>' . $translator->__f('Message with id %id% could not be found', ['%id%' => $entityId]) . '</em>';

        return $cache[$nid];
    }

    $title = $container->get('mu_news_module.entity_display_helper')->getFormattedTitle($entity);
    $cache[$nid] = '<a href="' . $router->generate('munewsmodule_messages_display', ['id' => $entityId]) . '" title="' . str_replace('"', '', $title) . '">' . $title . '</a>';

    return $cache[$nid];
}
